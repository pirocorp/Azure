# Create a multi-tier solution by using Azure services


# Architecture diagram

![image](https://user-images.githubusercontent.com/34960418/169032789-fd4da015-8826-46a9-88a1-4ae805278905.png)


# Create an Azure App Service resource by using a Docker container image

## Open the [Azure portal](https://portal.azure.com)


## Create a web app by using Azure App Service resource by using an httpbin container image

In the Azure portal, use the **Search resources, services, and docs** text box to search for **App Services** and, in the list of results, select **App Services**. On the **App Services** blade, select **+ Create**.

![image](https://user-images.githubusercontent.com/34960418/169034373-77372c43-e0bf-44c0-97b4-b7d4de2a5d3f.png)


On the **Create Web App** blade, on the **Basics** tab, perform the following actions:
    
| Setting | Action |
| --- | --- |
| **Subscription** drop-down list | Retain the default value. |
| **Resource group** section      | Select **Create new**, enter **ApiService**,  and then select **OK**. |
| **Name** text box  | Enter **httpapi** *[yourname]* |
| **Publish** section  | Select **Docker Container** |
| **Operating System** section | Select **Linux** |
| **Region** drop-down  list | Select any Azure region in which you can deploy an Azure web app. |
| **App Service Plan** section | Select **Create new**, enter  the value **ApiPlan** in the **Name** text  box, and then select **OK**. |
| **SKU and size** section | Select **Change size**, on the **Spec  Picker** blade, select **See additional options**, select **S1**, and then select **Apply**. |

Select **Next: Docker >**.

![image](https://user-images.githubusercontent.com/34960418/169036781-beda5d7a-ed59-4d85-b285-ec2d8fb672e9.png)


On the **Docker** tab, perform the following actions, and then select **Review + create**:

| Setting | Action  |
| --- | --- |
| **Options** drop-down list  | Select **Single Container** |
| **Image Source** drop-down list | Select **Docker Hub** |
| **Access Type** drop-down list  | Select **Public** |
| **Image and tag** text box      | Enter **kennethreitz/httpbin:latest** |

On the **Review + create** tab, review the options that you selected during the previous steps. Select **Create** to create the web app by using your specified configuration.

> **Note**: Wait for the creation task to complete before you proceed with this lab.


## Test the httpbin web application

On the blade displaying the newly created app properties, select **Browse**. 

![image](https://user-images.githubusercontent.com/34960418/169037643-bfca1c5d-cca3-4850-8210-2870582341d0.png)

![image](https://user-images.githubusercontent.com/34960418/169037699-86bab58a-6eca-4d93-b73d-51f0766ddc9b.png)


Within the web application select **Response formats**. Select **GET /html**. Select **Try it out**. Select **Execute**. 

![image](https://user-images.githubusercontent.com/34960418/169037998-bfdb89ea-087e-4389-b0ec-a615fe61665e.png)


Review the value of the **Response body** and **Response headers** text boxes. Review the value of the **Request URL** text box.

![image](https://user-images.githubusercontent.com/34960418/169038276-02d15d4d-1414-4755-a0de-277600f1503f.png)


Within the web application, perform the following actions: Select **Dynamic data**. Select **GET /bytes/{n}**. Select **Try it out**. In the **n** text box, enter **25**. Select **Execute**.

![image](https://user-images.githubusercontent.com/34960418/169038781-ad3985bd-0309-4337-86b7-cb8445f4c31e.png)


Review the value of the **Response body** and **Response headers** text boxes. Select **Download file**, and after the file downloads, open it in Notepad, review its content, and then close it.

![image](https://user-images.githubusercontent.com/34960418/169039015-30596027-5021-45f5-85da-e792bdbbbd06.png)

![image](https://user-images.githubusercontent.com/34960418/169039120-2e21d541-cae8-4389-8839-51f4d53f31cc.png)

> **Note**: The file contains a sequence of randomly generated bytes.


Within the web application, perform the following actions: Select **Status codes**. Select **GET /status/{codes}**. Select **Try it out**. In the **codes** text box, enter **404**. Select **Execute**.

![image](https://user-images.githubusercontent.com/34960418/169039451-816c9100-862e-42a7-b54f-923c8d0f3c3f.png)


Review the **Server response** and note that it includes **Error: NOT FOUND** entry.

![image](https://user-images.githubusercontent.com/34960418/169039582-093cc953-fcf3-41b4-82a1-6d708206abc7.png)


Switch back to the browser window that displays the **httpapi**_[yourname]_ web app. In the **Settings** section, select the **Properties** link. In the **Properties** section, record the value of the **URL** link. You'll use this value later in the lab to send requests to the corresponding API.

![image](https://user-images.githubusercontent.com/34960418/169039999-e791ebd8-2717-47ee-b6c4-9f8872138d40.png)


## Review

In this exercise, you created a new Azure web app by using a container image sourced from Docker Hub.


# Build an API proxy tier by using Azure API Management

## Create an API Management resource

In the Azure portal, use the **Search resources, services, and docs** text box to search for **API Management services** and, in the list of results, select **API Management services**. On the **API Management services** blade, select **+ Create**.

![image](https://user-images.githubusercontent.com/34960418/169048105-84941ddc-1e22-493a-8796-4da73021db63.png)


On the **Create API Management** blade, perform the following actions, and then select **Review + create**:
    
| Setting | Action |
| --- | --- |
| **Subscription** drop-down list | Retain the default value. |
| **Resource group** section | Select the **ApiService** group that you created  earlier in the lab. |
| **Resource name** text box  | Enter **proapi** *[yourname]*. |
| **Region** list | Select the same region you chose in the previous exercise.   |
| **Organization name** text box    | Enter **Contoso** |
| **Administrator email** text  box | Enter `admin@contoso.com` |
| **Pricing tier** drop-down  list   | **Consumption (99.95% SLA)** |

The following screenshot displays the configured settings of **Create API Management** blade of the web application.

![image](https://user-images.githubusercontent.com/34960418/169048648-4d0c74ef-5c3b-466b-8270-1e9f4387e9e6.png)


On the **Review + create** tab, review the option that you specified in the previous step, and then select **Create**. On the **Deployment Overview** blade, select **Go to resource**.

> **Note**: Wait for the creation task to complete before you continue with this lab.


## Define a new API

On the **API Management Service** blade, in the **APIs** section, select **APIs**. In the **Define a new API** section, select **HTTP**.

![image](https://user-images.githubusercontent.com/34960418/169052334-3f2e409e-3a1b-452e-aad4-aafdceb0fa47.png)


In the **Create a blank API** window, perform the following actions and select **Create**:
    
| Setting | Action |
| --- | --- |
| **Display name** text box    | Enter **HTTPBin API** |
| **Name** text box | Enter **httpbin-api**. |
| **Web service URL** text box | Enter the URL for the web app that you copied earlier in this lab. **Note**: Make sure that the URL starts with the https:// prefix. |
| **API URL suffix** text box   | Leave it empty.  |

The following screenshot displays the configured settings of **Create an HTTP API** window of the web application.

![image](https://user-images.githubusercontent.com/34960418/169053241-8c6d5b0d-fe30-4b59-9253-b4f2383b8ab9.png)

> **Note**: Wait for the new API to finish being created.


On the **Design** tab, select **+ Add operation**. 

![image](https://user-images.githubusercontent.com/34960418/169054336-466da958-0faa-46ad-84b5-b8d2202dd933.png)


In the **Add operation** section, perform the following actions, and then select **Save**:

| Setting                           | Action                                                       |
| --------------------------------- | ------------------------------------------------------------ |
| **Display name** text box    | Enter **Echo Headers**.              |
| **Name** text box | Verify that its value is set to **echo-headers**.|
| **URL** list        | Select **GET**.              |
| **URL** text box   | Enter **/**.  |

The following screenshot displays the configured settings of the **Add operation** section.

![image](https://user-images.githubusercontent.com/34960418/169054700-0481eff0-43da-494b-a943-7c2776928abf.png)


Back on the **Design** tab, in the list of operations, select **Echo Headers**. In the **Design** section, on the **Inbound processing** tile select **+ Add policy**.

![image](https://user-images.githubusercontent.com/34960418/169055616-b09d8bd3-1da5-41fc-b697-77d87e9c770f.png)


In the **Add inbound policy** section, select the **Set headers** tile.

![image](https://user-images.githubusercontent.com/34960418/169056009-2836cf1a-2d45-4d2e-bee5-6703a8953553.png)


In the **Set Headers** section, perform the following actions, and then select **Save**:
    
| Setting                           | Action                                                       |
| --------------------------------- | ------------------------------------------------------------ |
| **Name** text box    | Enter **source**.                          |
| **Value** text box | Select the list, select **Add Value**, and then enter **azure-api-mgmt**. |
| **Action** list        | Select **append**.              |

The following screenshot displays the configured settings of the **Design** section.

![image](https://user-images.githubusercontent.com/34960418/169056407-308943ca-2c19-4bf0-848f-49e06713bfae.png)


Back on the **Design** tab, in the list of operations, select **Echo Headers**. In the **Design** section for **Echo Headers**, on the **Backend** tile, select the pencil icon.

![image](https://user-images.githubusercontent.com/34960418/169057946-16bec446-e3fd-4afe-a310-c7a0027efc47.png)


In the **Backend** section, perform the following actions, and then select **Save**:

| Setting                           | Action                                                       |
| --------------------------------- | ------------------------------------------------------------ |
| **Service URL** section    | Select the **Override** check box.|
| **Service URL** text box | Append the value **/headers** to its current value. **Note**: For example, if the current value is `http://httpapi[yourname].azurewebsites.net`, the new value will be `http://httpapi[yourname].azurewebsites.net/headers`.|

![image](https://user-images.githubusercontent.com/34960418/169058544-4d9e6021-f380-493b-83bd-9ca705414578.png)

 
Back on the **Design** tab, in the list of operations, select **Echo Headers**, and then select the **Test** tab. In the **Echo Headers** section, select **Send**.

The following screenshot displays the configured settings of the **Echo Headers** section.

![image](https://user-images.githubusercontent.com/34960418/169059600-d510cb0a-a031-4136-ad45-89c0b1e466fe.png)




