# Monitor services that are deployed to Azure

# Architecture diagram

![image](https://user-images.githubusercontent.com/34960418/169530615-39fe3c67-bbcb-4ea1-9b7d-555dd2de5474.png)


# Create and configure Azure resources

## Open the [Azure potal](https://portal.azure.com/)


## Create an Application Insights resource

In the Azure portal, use the **Search resources, services, and docs** text box at the top of the page to search for **Application Insights** and then, in the list of results, select **Application Insights**. On the **Application Insights** blade, select **+ Create**.

![image](https://user-images.githubusercontent.com/34960418/169532437-c3ba0812-8086-4dee-976d-790fa85d725f.png)


On the **Application Insights** blade, on the **Basics** tab, perform the following actions, and select **Review + Create**:
    
| Setting                         | Action                                                       |
| ------------------------------- | ------------------------------------------------------------ |
| **Subscription** drop-down list | Retain the default value.                                    |
| **Resource group** section      | Select **Create new**, enter **MonitoredAssets**, and then select **OK**. |
| **Name** text box     | **instrm**_[yourname]_.                           |
| **Region** drop-down list       | Select any Azure region in which you can deploy an Azure Service Bus. |
| **Resource Mode** section | Select the **Workspace-based** option.|
| **WORKSPACE DETAILS** section | Retain the default values for the **Subscription** and **Log Analytics Workspace** drop-down lists.|

![image](https://user-images.githubusercontent.com/34960418/169532919-fbdc8121-c101-44ba-8890-bbc873ed0806.png)

The following screenshot displays the configured settings on the **Application Insights** blade.


On the **Review + Create** tab, review the options that you selected during the previous steps. Select **Create** to create the **Application Insights** instance by using your specified configuration.

> **Note**: Wait for the creation task to complete before you proceed with this lab.


On the **Microsoft.AppInsights \| Overview** blade, select the **Go to resource** button to navigate to the blade of the newly created **Application Insights** resource. On the **Application Insights** blade, in the **Configure** section, select the **Properties** link. On the **Properties** blade, next to the **Instrumentation Key** entry, select the **Copy to clipboard** button, and then record the copied value. You'll use it later in this lab.

![image](https://user-images.githubusercontent.com/34960418/169533445-fc4fe500-9909-4f17-8734-030749312ace.png)

> **Note**: The key is used by client applications to connect to a specific **Application Insights** resource.


## Create an Azure Web API resource

In the Azure portal, use the **Search resources, services, and docs** text box at the top of the page to search for **App Services** and then, in the list of results, select **App Services**. On the **App Services** blade, select **+ Create**.

![image](https://user-images.githubusercontent.com/34960418/169533776-9055968d-174d-4320-a67d-220699dc3421.png)


On the **Create Web App** blade, on the **Basics** tab, perform the following actions, and then select **Next: Deployment**:

| Setting                         | Action                                                       |
| ------------------------------- | ------------------------------------------------------------ |
| **Subscription** drop-down list | Retain the default value.                                    |
| **Resource group** drop-down list      |Select **MonitoredAssets**. |
| **Name** text box     | Enter **smpapi**_[yourname]_ |
| **Publish** section       | Select **Code**. |
| **Runtime stack** drop-down list | Select **.NET Core 3.1 (LTS)**.|
| **Operating System** section |  Select **Windows**.|
| **Region** drop-down list |  Select the same region you chose as the location of the **Application Instance** resource. |
| **App Service Plan** section |  Select **Create new**. |
| **Name** text box |  Enter **MonitoredPlan**, and then select **OK**.|
|  **SKU and size** section |  Retain the default value. |

![image](https://user-images.githubusercontent.com/34960418/169534552-b56f93e4-b01f-4b66-9638-1190bb0c1dab.png)


On the **Deployment** tab, select **Next: Monitoring**. On the **Monitoring** tab, perform the following actions, and then select **Review + Create**.

| Setting                         | Action                                                       |
| ------------------------------- | ------------------------------------------------------------ |
| **Enable Application Insights** section | Ensure that **Yes** is selected.                                    |
| **Application Insights** drop-down list     | Select the **instrm**_[yourname]_ Application Insights resource that you created previously in this lab.|

![image](https://user-images.githubusercontent.com/34960418/169534930-f04a8fbb-6a73-4139-bcd4-a3149812e777.png)

On the **Review + Create** tab, review the options that you selected during the previous steps. Select **Create** to create the web API by using your specified configuration.

> **Note**: Wait for the creation task to complete before you proceed with this lab.


On the deployment **Overview** blade, select the **Go to resource** button to navigate to the blade of the newly created Azure web API. On the **App Service** blade, in the **Settings** section, select the **Configuration** link. In the **Configuration** section, perform the following actions:

- On the **Application settings** tab, select **Show Values** to display secrets associated with your web API.
- Note the value representing the **APPINSIGHTS\_INSTRUMENTATIONKEY** key. This value was set automatically when you built the web API resource.

![image](https://user-images.githubusercontent.com/34960418/169535611-4bd95943-1853-42fb-a1b6-18bab6023781.png)


On the **App Service** blade, in the **Settings** section, select the **Properties** link. In the **Properties** section, record the value of the **URL** link. You'll use this value later in the lab to submit requests to the web API.

![image](https://user-images.githubusercontent.com/34960418/169536079-a9a57790-dd81-47a6-beb4-46be7a8dec01.png)


## Configure web API autoscale options

On the **App Service** blade, in the **Settings** section, select the **Scale out (App Service Plan)** link. In the **Scale out** section, perform the following actions, and then select **Save**:

| Setting                         | Action                                                       |
| ------------------------------- | ------------------------------------------------------------ |
| **Scale out** section | Select **Custom autoscale**.|
| **Autoscale setting name** text box     | Enter **ComputeScaler**.|
| **Resource group** drop-down list     |Select **MonitoredAssets**. |
| **Scale mode** section      | Select **Scale based on a metric**. |
| **Minimum** text box in the **Instance limits** section | Enter **2**.|
| **Maximum** text box in the **Instance limits** section | Enter **8**.|
| **Default** text box in the **Instance limits** section | Enter **3**. |

![image](https://user-images.githubusercontent.com/34960418/169537939-ff67bfbd-10e6-4981-9cd5-e04bc34ca2f7.png)

| Setting                         | Action                                                       |
| ------------------------------- | ------------------------------------------------------------ |
| **Rules** section |  Select **Add a rule**.|
| **Scale rule** blade | Retain default values for all settings, and then select **Add**.|

The following screenshot displays additional settings in the **Scale out** section on the **App Service** blade.

![image](https://user-images.githubusercontent.com/34960418/169537643-aa66521a-22f4-4b04-947d-e3f3b28b9690.png)

> **Note**: Wait for the save operation to complete before you continue with this lab.


## Review

In this exercise, you created the Azure resources that you'll use for the remainder of the lab.


# Monitor a local web API by using Application Insights

## Build a .NET Web API project

Create a new .NET Web API application named **SimpleApi**. Import **Microsoft.ApplicationInsights**, **Microsoft.ApplicationInsights.AspNetCore**, **Microsoft.ApplicationInsights.PerfCounterCollector**, from NuGet to the current project. Build the project.


## Update app code to disable HTTPS and use Application Insights

Open the **Startup.cs** file. Locate and delete the following code.

```csharp
app.UseHttpsRedirection();
```

> **Note**: This line of code forces the web API to use HTTPS. For this lab, this is unnecessary.


At the beginning of the definition of the **Program** class, add a new static string constant named **INSTRUMENTATION_KEY** with the value set to the Application Insights resource instrumentation key that you recorded previously in this lab:

```csharp
private const string INSTRUMENTATION_KEY = "instrumentation_key";
```

> **Note**: For example, if your instrumentation key is `d2bb0eed-1342-4394-9b0c-8a56d21aaa43`, that line of code would be `private const string INSTRUMENTATION_KEY = "d2bb0eed-1342-4394-9b0c-8a56d21aaa43";`


Locate the **ConfigureServices** method in the **Program** class:

```csharp
private static void ConfigureServices(IServiceCollection services)
{
}
```


Starting from a new line, add the following code at the end of the **ConfigureServices** method to configure Application Insights using the provided instrumentation key:

```csharp
services.AddApplicationInsightsTelemetry(INSTRUMENTATION_KEY);
```

Save the **Program.cs** file. Build the application.


## Test an API application locally

Launch the .NET Web API. In the browser window that opens, navigate to the page in which the URL contains the **/weatherforecast** relative path of your web API, which at this point is hosted at **localhost** on port **5000**.

> **Note**: The full URL is `http://localhost:5000/weatherforecast`.

> **Note**: The page should contain an output in the following format:

![image](https://user-images.githubusercontent.com/34960418/169543622-f2bc45a3-2237-4938-baab-2a572700c6b8.png)


## Review metrics in Application Insights

In the Azure portal, navigate back to the blade of the **instrm**_[yourname]_ Application Insights resource you created previously in this lab. On the **Application Insights** blade, in the tiles in the center of the blade, find the displayed metrics. Specifically, find the number of server requests that have occurred and the average server response time.

The following screenshot displays the **Application Insights** metrics of the local web app.

![image](https://user-images.githubusercontent.com/34960418/169543974-d8cd29ec-0133-4c13-81cb-8573a85b6569.png)

> **Note**: It can take up to five minutes to observe requests in the Application Insights metrics charts.


## Review

In this exercise, you created an API app by using ASP.NET and configured it to stream application metrics to Application Insights. You then used the Application Insights dashboard to review performance details about your API.


# Monitor a web API using Application Insights

## Deploy an application to the web API

Add a file named **web.config** to the directory. Open the **web.config** file and add the following content:

```xml
<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <location path="." inheritInChildApplications="false">
    <system.webServer>
      <handlers>
        <add name="aspNetCore" path="*" verb="*" modules="AspNetCoreModuleV2" resourceType="Unspecified" />
      </handlers>
      <aspNetCore processPath="dotnet" arguments=".\SimpleApi.dll" stdoutLogEnabled="false" stdoutLogFile=".\logs\stdout" hostingModel="inprocess" />
    </system.webServer>
  </location>
</configuration>
```
