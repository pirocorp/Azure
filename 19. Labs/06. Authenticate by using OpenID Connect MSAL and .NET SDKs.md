# Authenticate by using OpenID Connect MSAL and .NET SDKs

# Architecture diagram

![image](https://user-images.githubusercontent.com/34960418/168565954-5d482ecb-bea6-493c-a0cd-92c0874385ec.png)


# Configure a single-tenant Azure AD environment

## Open the [Azure portal](https://portal.azure.com)


## Register an application in Azure AD

In the Azure portal, use the **Search resources, services, and docs** text box to search for **Azure Active Directory** and, in the list of results, select **Azure Active Directory**.

> **Note**: This redirects your browser session to the blade of the Azure Active Directory (Azure AD) tenant associated with your Azure subscription.

![image](https://user-images.githubusercontent.com/34960418/168567488-37368474-fb89-4003-9e6a-449439c735a0.png)


On the **Azure Active Directory** blade, select **App registrations** in the **Manage** section. In the **App registrations** section, select **+ New registration**.

![image](https://user-images.githubusercontent.com/34960418/168568012-fc4c5b1f-104a-4d9f-8718-94f9832d00eb.png)


In the **Register an application** section, perform the following actions, and then select **Register**:

| Setting | Action |
| --- | --- |
| **Name** text box | Enter **webappoidc** |
| **Supported account types** list | Select **Accounts in this organizational directory only (Default Directory only - Single tenant)** |

The following screenshot displays the configured settings in the **Register an application** section.

![image](https://user-images.githubusercontent.com/34960418/168568441-191e74b6-587a-40b0-84bd-375e060e6418.png)


## Record unique identifiers

On the **webappoidc** application registration blade, select **Overview**. In the **Overview** section, find and record the value of the **Application (client) ID** text box. You'll use this value later in the lab. In the **Overview** section, find and record the value of the **Directory (tenant) ID** text box. You'll use this value later in the lab.

![image](https://user-images.githubusercontent.com/34960418/168594573-65e0d8da-238a-4928-8080-9fb83055635d.png)


## Configure the application authentication settings

On the **webappoidc** application registration blade, select **Authentication** in the **Manage** section. 

![image](https://user-images.githubusercontent.com/34960418/168595289-a4071cf1-249d-4f97-a986-e69663f9650c.png)


In the **Authentication** section, perform the following actions, and select **Configure**:

| Setting | Action |
| --- | --- |
| **Platform configurations** section | Select **+ Add a platform** |
| **Configure platforms** blade  | Select **Web** |
| **Redirect URIs** text box | Enter `https://localhost:44321/` |
| **Front-channel logout URL** text box   | Enter  `https://localhost:44321/signout-oidc` |
|**Implicit grant and hybrid flows** section | Select **ID tokens (used for implicit and hybrid  flows)** |

![image](https://user-images.githubusercontent.com/34960418/168596617-0b24c9a4-46a1-402e-95d7-346f5f44e13a.png)


Back in the **Platform configurations** section, select **Add URI**, and then enter `https://localhost:44321/signin-oidc`. Select **Save**. The following screenshot displays the configured settings on the **Authentication** blade.

![image](https://user-images.githubusercontent.com/34960418/168597299-6dd5c140-a96c-4868-9a82-3256844cf545.png)


## Create an Azure AD user

Login in Azure

```bash
az login
```


Run the following command to retrieve and display the primary Domain Name System (DNS) domain name of the Azure AD tenant:

```bash
$AAD_DOMAIN_NAME = az ad app list --query [0].publisherDomain
$AAD_DOMAIN_NAME
```

![image](https://user-images.githubusercontent.com/34960418/168617119-0a7284c5-3fbe-47e4-8f52-15d98deb7a22.png)


Run the following commands to create Azure AD user that you'll use to test Azure AD authentication

```bash
az ad user create --display-name "aad_lab_user1" `
                  --password "Pa55w.rd1234" `
                  --user-principal-name "aad_lab_user1@$AAD_DOMAIN_NAME" `
                  --force-change-password-next-login false `
                  --mail-nickname "aad_lab_user1"
```

![image](https://user-images.githubusercontent.com/34960418/168618702-6450145f-155e-4c5e-a849-eaa94a4ffc5b.png)


Run the following command to identify the user principal name (UPN) of the newly created Azure AD user:

```bash
az ad user list --query [].userPrincipalName
```

![image](https://user-images.githubusercontent.com/34960418/168618817-ea4de2bd-15ee-4642-b690-98a31e641e2b.png)

> **Note**: Record the UPN. You'll use this value later in the lab.


## Review

In this exercise, you registered a single-tenant Azure AD application and created an Azure AD user account.


# Create a single-tenant ASP.NET Core web app

## Create an ASP.NET Core web app project

Change folder to `OIDCClient`. Run the following commands to create a new .NET Core web app based on the Model View Controller (MVC) template (replace the placeholders `<application_ID>`, `<tenant_ID>`, and `<domain_Name>` with the corresponding values you recorded earlier in this lab):

```powershell
dotnet new mvc --auth SingleOrg --client-id <application_ID> --tenant-id <tenant_ID> --domain <domain_Name>
```
![image](https://user-images.githubusercontent.com/34960418/168778132-6c38532d-61a4-4e4b-adc6-933107c926a1.png)


Navigate to the **Properties** folder, open the **launchSettings.json** file, and then apply the following changes:

| Section | Property  | Value |
| --- | --- | --- |
| **iisSettings** | **sslPort** | **44321** |
| **OIDCClient**  | **applicationUrl** | `https://localhost:44321` |

> **Note**: The port numbers must match the value you specified when creating the Azure AD app registration.
